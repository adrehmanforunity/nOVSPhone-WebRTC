<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Call Application with Device Selection and Registration</title>
    <script type="text/javascript" src="https://dtd6jl0d42sve.cloudfront.net/lib/SipJS/sip-0.20.0.min.js" defer="true"></script>
</head>
<body>
    <button id="permissionButton">Grant Permission</button>

    <label for="audioInputSelect">Audio Input Device:</label>
    <select id="audioInputSelect"></select>

    <label for="audioOutputSelect">Audio Output Device:</label>
    <select id="audioOutputSelect"></select>

    <audio id="localAudio" autoplay></audio>
    <audio id="remoteAudio" autoplay></audio>

    <button id="registerButton">Register</button>
    <button id="unregisterButton">Unregister</button>
    <button id="callButton">Call *43</button>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var SipUsername = '2001';
            var SipPassword = 'ab0000';
            var SipDomain = 'webrtc.kozow.com';
            var audioInputSelect = document.getElementById('audioInputSelect');
            var audioOutputSelect = document.getElementById('audioOutputSelect');
            var userAgent;
            var registered = false;

            function getPermissionAndUpdateDevices() {
                navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                    .then(function(stream) {
                        updateDeviceSelection();
                        stream.getTracks().forEach(function(track) {
                            track.stop();
                        });
                    })
                    .catch(function(error) {
                        console.error('Error accessing media devices.', error);
                    });
            }

            function updateDeviceSelection() {
                navigator.mediaDevices.enumerateDevices()
                    .then(function(devices) {
                        audioInputSelect.innerHTML = '';
                        audioOutputSelect.innerHTML = '';
                        devices.forEach(function(device) {
                            var option = document.createElement('option');
                            option.value = device.deviceId;
                            option.text = device.label || 'Device ' + (device.deviceId.substr(0, 6)) + '...';
                            if (device.kind === 'audioinput') {
                                audioInputSelect.appendChild(option);
                            } else if (device.kind === 'audiooutput') {
                                audioOutputSelect.appendChild(option);
                            }
                        });
                    });
            }

            document.getElementById('permissionButton').addEventListener('click', getPermissionAndUpdateDevices);

            document.getElementById('registerButton').addEventListener('click', function () {
                if (!userAgent) {
                    var userAgentOptions = {
                        uri: SIP.UserAgent.makeURI("sip:" + SipUsername + "@" + SipDomain),
                        transportOptions: {
                            server: 'wss://' + SipDomain + ':4443/ws',
                            traceSip: true
                        },
                        authorizationUsername: SipUsername,
                        authorizationPassword: SipPassword,
                        sessionDescriptionHandlerFactoryOptions: {
                            constraints: {
                                audio: true,
                                video: false
                            }
                        },
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' }
                        ]
                    };

                    userAgent = new SIP.UserAgent(userAgentOptions);

                    userAgent.start().then(() => {
                        console.log('User agent started');
                    }).catch(error => {
                        console.error('Error starting user agent:', error);
                    });

                    userAgent.on('registered', function () {
                        registered = true;
                        console.log('Registration successful!');
                    });

                    userAgent.on('unregistered', function () {
                        registered = false;
                        console.log('Unregistration successful!');
                    });

                    userAgent.on('registrationFailed', function (error) {
                        console.error('Registration failed:', error);
                    });
                }

                if (!registered) {
                    userAgent.register();
                }
            });

            document.getElementById('unregisterButton').addEventListener('click', function () {
                if (userAgent && registered) {
                    userAgent.unregister();
                }
            });

            document.getElementById('callButton').addEventListener('click', function () {
                if (userAgent && registered) {
                    var options = {
                        sessionDescriptionHandlerOptions: {
                            constraints: {
                                audio: {
                                    deviceId: audioInputSelect.value ? { exact: audioInputSelect.value } : undefined
                                },
                                video: false
                            }
                        }
                    };

                    userAgent.invite('*43', options);
                } else {
                    console.error('User agent is not registered.');
                }
            });
        });
    </script>
</body>
</html>
